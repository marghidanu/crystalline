name: Build

on:
  push:
    branches: [master]

jobs:
  macos:
    name: macOS (arm64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: crystal-lang/install-crystal@v1
        with:
          crystal: 1.19.1
      - run: shards install --production
      - name: Build
        run: shards build crystalline --release --no-debug -Dpreview_mt --stats --progress
      - uses: actions/upload-artifact@v4
        with:
          name: crystalline_arm64-apple-darwin
          path: ./bin/crystalline

  linux:
    name: Linux (x86_64, static)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build static binary
        run: docker build -t crystalline .
      - name: Extract binary
        run: |
          docker run -v $PWD:/out --rm crystalline:latest cp /usr/local/bin/crystalline /out/crystalline
      - uses: actions/upload-artifact@v4
        with:
          name: crystalline_x86_64-unknown-linux-musl
          path: ./crystalline

  docker:
    name: Docker image
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
