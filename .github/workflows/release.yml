name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  macos:
    name: macOS (arm64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: crystal-lang/install-crystal@v1
        with:
          crystal: 1.19.1
      - name: Install LLVM
        run: brew install llvm@20
      - run: shards install --production
      - name: Build
        env:
          LLVM_CONFIG: /opt/homebrew/opt/llvm@20/bin/llvm-config
        run: shards build crystalline --release --no-debug -Dpreview_mt --stats --progress
      - uses: actions/upload-artifact@v4
        with:
          name: crystalline_arm64-apple-darwin
          path: ./bin/crystalline

  linux:
    name: Linux (x86_64, static)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build static binary
        run: docker build -t crystalline .
      - name: Extract binary
        run: |
          docker run -v $PWD:/out --rm crystalline:latest cp /usr/local/bin/crystalline /out/crystalline
      - uses: actions/upload-artifact@v4
        with:
          name: crystalline_x86_64-unknown-linux-musl
          path: ./crystalline

  docker:
    name: Docker image
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository }}:latest

  publish:
    name: GitHub Release
    needs: [macos, linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Compress artifacts
        run: gzip -r ./artifacts
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/crystalline_x86_64-unknown-linux-musl/crystalline.gz
            ./artifacts/crystalline_arm64-apple-darwin/crystalline.gz
